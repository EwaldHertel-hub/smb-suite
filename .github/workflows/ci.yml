name: CI


on:
push:
branches: [ main ]
pull_request:
branches: [ main ]


jobs:
build-test:
runs-on: ubuntu-latest


services:
postgres:
image: postgres:16
env:
POSTGRES_USER: app
POSTGRES_PASSWORD: app
POSTGRES_DB: app
ports: ['5432:5432']
options: >-
--health-cmd "pg_isready -U app" \
--health-interval 10s \
--health-timeout 5s \
--health-retries 5
redis:
image: redis:7
ports: ['6379:6379']


env:
DATABASE_URL: postgresql://app:app@localhost:5432/app?schema=public
REDIS_URL: redis://localhost:6379
JWT_SECRET: ci_secret
EMAIL_SMTP_HOST: localhost
EMAIL_SMTP_PORT: 1025
EMAIL_FROM: ci@example.com
NEXT_PUBLIC_API_URL: http://localhost:3001


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Setup PNPM
uses: pnpm/action-setup@v4
with:
version: 9


- name: Setup Node
uses: actions/setup-node@v4
with:
node-version: 20
cache: 'pnpm'


- name: Install deps
run: pnpm install --frozen-lockfile


- name: Generate Prisma Client
run: pnpm --filter api prisma:gen


- name: Run DB migrations
run: pnpm --filter api prisma:migrate -- --skip-generate


- name: Build (all workspaces)
run: pnpm -r build


- name: Test (if present)
run: pnpm -r test --if-present


- name: Lint (if present)
run: pnpm -r lint --if-present